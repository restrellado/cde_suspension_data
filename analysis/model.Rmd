---
title: "R Notebook"
output: html_notebook
---

# Load data 

```{r load raw data}
source(here::here("src", "clean_data.R"))
```

```{r race groups}
race_groups <- c("African American", "American Indian or Alaska Native", "Asian",
                 "Filipino", "Hispanic or Latino", "Pacific Islander", 
                 "Two or More Races", "White")
```

# Clean data

Suspension counts are unduplicated counts of students suspended. This means that if a student got suspended three times, they would only be counted once in the dataset. We'll be comparing racial subgroups so we'll drop all levels of `reporting_category` except the racial subgroups. 

```{r filter total}
# Cleaning drops 118362 rows 
total_sus <- school_sus %>% 
  filter(
    # Total counts for racial subgroups
    reporting_category %in% race_groups, 
    # Drop rows where enrollment is not reported because of small n size
    !is.na(cumulative_enrollment)) 
```

```{r make 14 digit code}
total_sus <- total_sus %>% 
  mutate(cds_code = paste0(county_code, district_code, school_code))
```

# Join suspension data set with school database 

```{r pick columns}
# Pick columns 
raw_schools <- raw_schools %>%  
  select(cds_code, status_type, charter, funding_type, doc_type, soc_type)
```

Less than 1 percent of the records in the total suspension dataset don't have a match in the California school database. 292 of the 347 of the non-matching records have a school code of "0000001". This might be because these were "dummy" school codes in the student systems used for non public schools. See documentation for more information.  

```{r look at non-matches}
# Compare to 6396 FALSE and 11728 TRUE
table(total_sus$cds_code %in% raw_schools$cds_code)
prop.table(table(total_sus$cds_code %in% raw_schools$cds_code))
```

```{r make a non-match status column}
total_sus$match_status <- total_sus$cds_code %in% raw_schools$cds_code
```

```{r join suspensions and school names}
total_sus <- left_join(total_sus, raw_schools, by = "cds_code")
```

Each row in this dataset is a unique cds code and reporting category. 

```{r uniqueness}
total_sus %>% 
  distinct(cds_code, reporting_category)
```
```{r convert racial subgroup to factor}

```


# Exploratory Data Analysis 

Plot student enrollment vs students suspended at least once. 

```{r plot student enrollment and students suspended}
ggplot(data = total_sus, 
       aes(x = cumulative_enrollment, 
           y = unduplicated_count_of_students_suspended_total, 
           color = reporting_category)) +
  geom_point(alpha = .5) +
  geom_smooth(method = "lm") + 
  labs(y = "Students suspended")
```

Model 1: Cumulative enrollment on number of students suspended at least once. 

```{r fit model 1}
fit_1 <- lm(unduplicated_count_of_students_suspended_total ~ cumulative_enrollment, 
          data = total_sus)

summary(fit_1)
```

On average, this model estimates that for every 100 students, about 3 students are suspended at least once. 

Model 2: cumulative enrollment on number of students suspended at least once, controlling for racial subgroup. 

```{r fit model 2}
fit_2 <- lm(unduplicated_count_of_students_suspended_total ~ cumulative_enrollment + reporting_category, 
          data = total_sus)

summary(fit_2)
```

```{r fit model 3}
fit_3 <- lm(unduplicated_count_of_students_suspended_total ~ cumulative_enrollment + reporting_category + soc_type, 
          data = total_sus)

summary(fit_3)
```

# About the Outliers

```{r}

```